<!DOCTYPE html>
<html lang="en">

<body onload="init()">
    <canvas id="canvas" width="2042" height="502"></canvas>
    <canvas id="textureCanvas" width="2042" height="502"></canvas>
</body>

</html>

<script>
    async function init() {
        var backgroundImage =  await getBackgroundImage();
        var textureImage = await getCombinedBackgroundImage(backgroundImage, "green_sparkle.png")
        draw(textureImage)

        test2()
    }

    async function test2() {
        var backgroundImage =  await getBackgroundImage();
        var textureImage = await getCombinedBackgroundImage(backgroundImage, "aegean_teal.jpg")
        draw(textureImage)
    }

    function draw(image) {
        var canvas = document.getElementById("canvas")
        var context = canvas.getContext("2d")
        
        context.save();
        context.setTransform(1, 0, 0, 1, 0, 0);
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.restore();        

        context.drawImage(image, 0, 0, image.width, image.height)
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getBackgroundImage() {
        var backgroundImage = new Image()

        var imageLoaded = false
        backgroundImage.onload = function() {
            imageLoaded = true 
        }

        backgroundImage.src = "white.png"
        while (!imageLoaded) {
            await sleep(500)
        }
        return backgroundImage
    }

 async function getCombinedBackgroundImage(backgroundImage, imageName) {
        var textureCanvas = document.getElementById("textureCanvas")
        var textureContext = textureCanvas.getContext("2d")
        var textureImage = new Image()

        var imageLoaded = false
        textureImage.onload = function () { 
            imageLoaded = true 
        }
        textureImage.src = imageName
        while (!imageLoaded) {
            await sleep(500)
        }

        textureContext.fillStyle = textureContext.createPattern(textureImage, "repeat");
        textureContext.fillRect(0, 0, textureCanvas.width, textureCanvas.height);
        textureContext.globalCompositeOperation = "multiply";
        textureContext.drawImage(backgroundImage, 0, 0, backgroundImage.width * 0.5, backgroundImage.height * 0.5);
        textureContext.globalCompositeOperation = "destination-in";
        textureContext.drawImage(backgroundImage, 0, 0, backgroundImage.width * 0.5, backgroundImage.height * 0.5);

        var image = new Image()
        image.src = textureCanvas.toDataURL()
        return image
    }
</script>