<!DOCTYPE html>
<html lang="en">

<body>
    <canvas id="canvas" width="2042" height="502"></canvas>
    <canvas id="textureCanvas" width="2042" height="502"></canvas>
</body>

</html>

<script src="canvas2image.js"></script>
<script>
    var body = document.getElementsByTagName("body")[0];
    body.addEventListener("load", init(), false);

    function init() {
        getBackgroundImage("green_sparkle.jpg", draw)
    }

    function draw() {
        var canvas = document.getElementById("canvas")
        var context = canvas.getContext("2d")

        var textureCanvas = document.getElementById("textureCanvas")
        let image = new Image();
        image.src = textureCanvas.toDataURL();
        context.drawImage(image, 0, 0, image.width, image.height)
    }

    function getBackgroundImage(imageName, completion) {
        var canvas = document.getElementById("textureCanvas")
        var context = canvas.getContext("2d")
        var backgroundImage = new Image
        var textureImage = new Image
        var count = 2
        var imagesLoaded = false

        backgroundImage.onload = textureImage.onload = function () { if (!--count) imagesLoaded = true }
        backgroundImage.src = "white.png"
        textureImage.src = imageName

        function waitForImages() {
            if (!imagesLoaded) {
                setTimeout(waitForImages, 100)
            } else {
                context.fillStyle = context.createPattern(textureImage, "repeat");
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.globalCompositeOperation = "multiply";
                context.drawImage(backgroundImage, 0, 0, backgroundImage.width * 0.5, backgroundImage.height * 0.5);
                context.globalCompositeOperation = "destination-in";
                context.drawImage(backgroundImage, 0, 0, backgroundImage.width * 0.5, backgroundImage.height * 0.5);
                //let image = canvas.toDataURL("image/png")
                completion()
            }
        }

        setTimeout(waitForImages, 100)    
    }

//var canvas = document.getElementById("canvas")
//var context = canvas.getContext("2d");
//var image = getBackgroundImage("green_sparkle.jpg")
//context.drawImage(image, 0, 0, image.width * 0.5, image.height * 0.5)

</script>